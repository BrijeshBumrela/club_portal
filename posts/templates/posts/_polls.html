{% load static %}
{% load club_user_filters %}
{% block styles %}
    <link rel="stylesheet" href="{% static 'posts/css/polls.css' %}">
{% endblock %}

<div class="poll">

    {% with post.poll as poll %}
        {% if poll.is_active and not poll|has_user_casted_vote:request.user %}
            <h2>Select your option</h2>
            <form action="{% url 'posts:cast-vote' club_name_slug post.encrypted_id %}" class="poll-submit" method="POST">
                <div class="question poll-question">
                    {#            <h3>Do You Like Subu Kandswamy?</h3>#}
                    {% csrf_token %}

                    {% for option in poll.option_set.all %}
                        <div class="poll-option option">
                            <input type="radio" id="option_{{ option.id }}"
                                   name="option" value="{{ option.id }}">
                            <label for="option_{{ option.id }}">{{ option.option_text }}</label>
                        </div>
                    {% empty %}
                        No options set for poll
                    {% endfor %}
                    <input type="submit" value="submit">
                </div>

            </form>

        {% else %}

            <div class="result poll-question">
                <h2 id="results">Here Are The Results</h2>

                {% with poll.total_votes as total_votes %}
                    {# To prevent queries and addition operations again and again#}
                    {% for option in poll.option_set.all %}
                        <div class="answer option">
                            <h3 class="option-text">{{ option.option_text }}</h3>
                            <h3 class="answer-value">{% widthratio option.num_votes total_votes 100 %}%</h3>
                            <div class="answer-bar">
                                <div class="filled-bar">
                                    &nbsp;
                                </div>
                            </div>
                            &nbsp;&nbsp;<span style="font-weight: bolder">({{ option.num_votes }})</span>
                        </div>


                    {% endfor %}
                {% endwith %}
            </div>

            <script>

                const bars = document.querySelectorAll('.filled-bar');
                const values = [...document.querySelectorAll('.answer-value')].map(answer => Number(answer.textContent.slice(0, -1)));


                for (let i = 0; i < bars.length; i++) {
                    let width = 1;

                    const id = setInterval(frame, 10);


                    function frame() {
                        if (width >= values[i]) {
                            clearInterval(id);
                        } else {
                            width++;
                            bars[i].style.width = width + '%';
                        }
                    }
                }


            </script>
        {% endif %}




    {% endwith %}

</div>


